# RS Agent MCP 项目开发手册

## ⚠️ 重要提示：开发前必读

**在开始任何开发工作之前，您必须完整阅读并理解以下内容：**

1. **本项目结构复杂，采用模块化架构** - 请完整阅读 `项目开发手册_项目结构图.md`，理解每个文件的作用和职责
2. **项目运行逻辑精巧** - 请仔细研究项目的数据流和业务逻辑，理解Agent、RAG、API之间的协作关系
3. **代码质量要求严格** - 本项目经历了从单体架构到模块化架构的重构，代码简洁性是核心价值
4. **向后兼容性至关重要** - 所有新功能必须保持与现有接口的兼容性
5. **测试覆盖要求高** - 所有新功能都需要有对应的测试用例

**🔴 强制要求：**
- 开发前必须完整阅读所有项目文件，理解项目运行逻辑
- 避免不必要的代码增加，保持代码简洁性
- 当代码变得冗长时，必须思考更好的结构优化方案
- 采用保守的开发方式，优先保证稳定性

---

## 1. 项目概述

### 1.1 项目简介
RS Agent MCP 是一个基于 FastAPI 和 LangChain 开发的微波遥感智能分析代理服务。该项目通过AI代理技术为用户提供微波遥感领域的专业知识问答、建模任务提交和结果分析等服务。

### 1.2 技术栈
- **后端框架**: FastAPI
- **AI框架**: LangChain
- **LLM客户端**: 支持OpenAI兼容接口、Ollama等
- **向量存储**: FAISS、TF-IDF双存储后端
- **认证**: RSHub token认证
- **部署模式**: 支持本地和生产模式

### 1.3 核心价值
- **专业领域**: 专注于微波遥感领域
- **智能分类**: 自动识别用户意图
- **知识增强**: 结合专业知识库提供准确回答
- **建模支持**: 完整的RSHub建模任务支持
- **模块化架构**: 高可维护性和可扩展性

---

## 2. 项目架构说明

### 2.1 整体架构
项目采用分层模块化架构，从单体架构重构为职责分离的模块化设计：

```
用户请求 → API路由 → Agent管理器 → 任务分类 → 具体Agent执行 → 结果返回
                                                    ↓
                                               RAG知识库查询
                                                    ↓
                                               RSHub工作流执行
```

### 2.2 核心模块

#### 2.2.1 Agent模块 (`app/agent/`)
**核心职责**: AI代理的调度和执行
**关键特性**:
- 采用工厂模式和管理器模式
- 支持多种指令模式：-1(通用)、0(分类)、1(知识)、2(建模提交)、3(结果获取)
- 向后兼容性保证

**主要文件**:
- `agent.py`: 统一接口层
- `core/agent_manager.py`: Agent管理器
- `core/task_classifier.py`: 任务分类器
- `core/agent_orchestrator.py`: Agent编排器

#### 2.2.2 RAG模块 (`app/rag/`)
**核心职责**: 知识库管理和检索
**关键特性**:
- 双存储后端：FAISS + TF-IDF
- 自动降级机制
- 支持多种文档格式

**主要文件**:
- `knowledge_base.py`: 统一接口
- `core/knowledge_manager.py`: 知识库管理器
- `core/embedder.py`: 嵌入模型管理
- `stores/faiss_store.py`: FAISS存储实现
- `stores/tfidf_store.py`: TF-IDF存储实现

#### 2.2.3 API模块 (`app/api/`)
**核心职责**: HTTP接口和路由管理
**关键特性**:
- 路由器模式设计
- 两阶段工作流
- WebSocket支持

**主要文件**:
- `routers/chat_router.py`: 核心聊天路由
- `routers/session_router.py`: 会话管理路由
- `routers/knowledge_router.py`: 知识库路由

#### 2.2.4 服务模块 (`app/services/`)
**核心职责**: 业务逻辑服务
**关键特性**:
- 按业务域组织
- 支持独立部署
- 统一错误处理

**主要文件**:
- `session/chat_service.py`: 会话管理
- `billing/billing_tracker.py`: 计费跟踪
- `auth/auth_service.py`: 认证服务
- `file/`: 文件服务模块

---

## 3. 功能模块详解

### 3.1 Agent系统

#### 3.1.1 指令模式系统
**文件**: `app/agent/core/task_classifier.py`
**功能**: 识别用户意图，返回对应的指令模式

**支持的指令模式**:
- `-1`: 通用回答模式
- `0`: 任务分类模式
- `1`: 知识问答模式
- `2`: RSHub建模任务提交
- `3`: RSHub任务结果获取

**开发新指令模式**:
1. 在 `task_classifier.py` 中添加新的分类逻辑
2. 在 `agent_orchestrator.py` 中添加对应的处理方法
3. 在 `langchain_agent_impl.py` 中实现具体功能
4. 添加相应的测试用例

#### 3.1.2 Agent管理器
**文件**: `app/agent/core/agent_manager.py`
**功能**: 统一管理所有Agent，负责任务调度

**关键方法**:
- `run_agent()`: 执行Agent任务
- `get_available_agents()`: 获取可用Agent列表
- `set_default_agent_type()`: 设置默认Agent类型

#### 3.1.3 Agent工厂
**文件**: `app/agent/core/agent_factory.py`
**功能**: 创建和配置Agent实例

**扩展新Agent类型**:
1. 创建新的Agent实现类
2. 在工厂中注册新的Agent类型
3. 更新配置文件支持新类型

### 3.2 RAG知识库系统

#### 3.2.1 知识库管理器
**文件**: `app/rag/core/knowledge_manager.py`
**功能**: 统一管理知识库的所有操作

**核心功能**:
- 文档处理和向量化
- 知识检索和排序
- 双存储后端管理
- 健康检查和统计

#### 3.2.2 向量存储系统
**文件**: `app/rag/core/vector_store.py`, `app/rag/stores/`
**功能**: 提供向量存储和检索能力

**存储后端**:
- **FAISS**: 语义搜索，需要嵌入模型
- **TF-IDF**: 关键词搜索，作为降级方案

**扩展新存储后端**:
1. 继承 `BaseVectorStore` 类
2. 实现必要的方法：`add_documents()`, `search()`, `health_check()`
3. 在 `vector_store.py` 中注册新后端

### 3.3 RSHub工作流系统

#### 3.3.1 工作流管理器
**文件**: `app/agent/workflows/rshub_workflow_impl.py`
**功能**: 管理RSHub建模任务的完整流程

**工作流类型**:
- **完整工作流**: 环境检查 → 任务分析 → 参数生成 → 任务提交 → 等待完成 → 结果可视化
- **仅提交工作流**: 只执行任务提交部分
- **仅获取结果工作流**: 只执行结果获取部分

#### 3.3.2 组件管理器
**文件**: `app/agent/workflows/rshub_components.py`
**功能**: 管理RSHub相关的各种组件

**主要组件**:
- 环境管理器
- 任务分析器
- 参数管理器
- 任务管理器

### 3.4 API路由系统

#### 3.4.1 聊天路由
**文件**: `app/api/routers/chat_router.py`
**功能**: 处理所有聊天相关的API请求

**核心端点**:
- `/agent/chat`: 标准聊天端点
- `/agent/chat/upload`: 文件上传聊天
- `/agent/knowledge`: 增强知识问答

**两阶段工作流**:
1. **Stage 1**: 任务分类 (`instruction=0`)
2. **Stage 2**: 执行具体任务

#### 3.4.2 会话管理路由
**文件**: `app/api/routers/session_router.py`
**功能**: 管理用户会话

**主要功能**:
- 会话创建和删除
- 会话列表获取
- 会话历史管理

### 3.5 服务层系统

#### 3.5.1 会话服务
**文件**: `app/services/session/chat_service.py`
**功能**: 管理用户会话数据

**主要功能**:
- 会话CRUD操作
- 会话标题生成
- 历史消息管理

#### 3.5.2 计费服务
**文件**: `app/services/billing/billing_tracker.py`
**功能**: 记录和跟踪资源使用情况

**计费项**:
- LLM调用次数
- RSHub任务提交次数
- 文件上传次数

#### 3.5.3 认证服务
**文件**: `app/services/auth/auth_service.py`
**功能**: 处理用户认证

**认证模式**:
- **生产模式**: 从RSHub主站获取token
- **本地模式**: 使用配置文件中的token

---

## 4. 项目维护指南

### 4.1 代码质量维护

#### 4.1.1 代码简洁性原则
**基本原则**:
- 避免不必要的代码增加
- 当代码超过200行时，考虑拆分
- 优先考虑代码可读性
- 遵循单一职责原则

**重构建议**:
- 定期检查代码复杂度
- 提取公共功能到独立模块
- 使用设计模式优化结构
- 保持模块间低耦合

#### 4.1.2 模块化维护
**维护策略**:
- 每个模块都应该有明确的职责
- 模块间通过接口通信
- 避免循环依赖
- 保持向后兼容性

### 4.2 测试维护

#### 4.2.1 测试结构
**测试目录**: `tests/`
**测试类型**:
- 单元测试 (`tests/unit/`)
- 集成测试 (`tests/integration/`)

#### 4.2.2 测试运行
**运行测试**: `python run_tests.py`
**测试配置**: `pytest.ini`

### 4.3 文档维护

#### 4.3.1 代码文档
**要求**:
- 所有公共函数都需要docstring
- 复杂逻辑需要注释说明
- 重要配置需要说明文档

#### 4.3.2 项目文档
**重要文档**:
- `README.md`: 项目概述
- `guide/`: 技术指南
- `项目开发手册.md`: 开发指南
- `项目开发手册_项目结构图.md`: 架构说明

---

## 5. 功能扩展指南

### 5.1 扩展新Agent功能

#### 5.1.1 添加新的指令模式
**步骤**:
1. **任务分类器修改** (`app/agent/core/task_classifier.py`):
   ```python
   # 在 _classify_by_keywords 方法中添加新的关键词识别
   elif any(keyword in user_input for keyword in ["新功能关键词"]):
       return 4  # 新的指令模式
   ```

2. **Agent编排器修改** (`app/agent/core/agent_orchestrator.py`):
   ```python
   # 添加新的处理方法
   async def _handle_new_instruction(self, session_id: str, user_input: str) -> Dict[str, Any]:
       # 实现新功能逻辑
       pass
   ```

3. **Agent实现修改** (`app/agent/core/langchain_agent_impl.py`):
   ```python
   # 添加新的指令模式支持
   elif instruction_mode == 4:
       return await self._handle_new_instruction(session_id, user_input)
   ```

4. **测试用例添加** (`tests/unit/test_task_classifier.py`):
   ```python
   def test_classify_new_instruction(self):
       result = self.classifier.classify_task("新功能请求")
       self.assertEqual(result, 4)
   ```

#### 5.1.2 添加新的Agent类型
**步骤**:
1. **创建新的Agent实现** (`app/agent/core/new_agent_impl.py`)
2. **在Agent工厂中注册** (`app/agent/core/agent_factory.py`)
3. **更新配置文件** (`app/core/config.py`)
4. **添加测试用例**

### 5.2 扩展RAG功能

#### 5.2.1 添加新的文档格式支持
**步骤**:
1. **修改文档处理器** (`app/utils/document_processor.py`)
2. **添加新的解析器**
3. **更新文件服务** (`app/services/file/processor_service.py`)
4. **添加测试用例**

#### 5.2.2 添加新的存储后端
**步骤**:
1. **创建新的存储实现** (`app/rag/stores/new_store.py`)
2. **继承BaseVectorStore类**
3. **在vector_store.py中注册**
4. **添加测试用例**

### 5.3 扩展API功能

#### 5.3.1 添加新的API端点
**步骤**:
1. **在对应的路由器中添加新端点**
2. **实现业务逻辑**
3. **添加错误处理**
4. **添加测试用例**
5. **更新API文档**

#### 5.3.2 添加新的WebSocket功能
**步骤**:
1. **在chat_router.py中添加WebSocket端点**
2. **实现实时通信逻辑**
3. **添加连接管理**
4. **添加测试用例**

---

## 6. 开发规范和最佳实践

### 6.1 代码规范

#### 6.1.1 Python代码风格
**遵循规范**:
- PEP 8 Python代码风格
- 类型注解 (Type Hints)
- 清晰的变量和函数命名
- 适当的异常处理

#### 6.1.2 导入规范
**导入顺序**:
1. 标准库导入
2. 第三方库导入
3. 本地模块导入

**避免循环导入**:
- 使用接口隔离
- 延迟导入
- 合理的模块组织

### 6.2 错误处理

#### 6.2.1 异常处理原则
**基本原则**:
- 捕获特定异常，避免裸露的 `except:`
- 提供有意义的错误信息
- 记录错误日志
- 优雅降级

#### 6.2.2 错误代码规范
**错误代码定义**:
- `-1`: 通用错误
- `-100` 到 `-199`: 认证相关错误
- `-200` 到 `-299`: Agent相关错误
- `-300` 到 `-399`: RAG相关错误
- `-400` 到 `-499`: RSHub相关错误

### 6.3 日志记录

#### 6.3.1 日志级别
**日志级别使用**:
- `DEBUG`: 详细的调试信息
- `INFO`: 一般信息
- `WARNING`: 警告信息
- `ERROR`: 错误信息
- `CRITICAL`: 严重错误

#### 6.3.2 日志格式
**统一格式**:
```python
logger.info(f"[{session_id}] 用户请求: {user_input}")
logger.error(f"[{session_id}] 任务执行失败: {str(e)}")
```

### 6.4 配置管理

#### 6.4.1 配置文件规范
**配置文件**: `app/core/config.py`
**环境变量**: `.env` 文件
**配置模板**: `env_template.txt`

#### 6.4.2 配置验证
**使用pydantic进行配置验证**:
- 类型检查
- 默认值设置
- 环境变量支持

---

## 7. 性能优化建议

### 7.1 代码优化

#### 7.1.1 识别性能瓶颈
**监控指标**:
- 函数执行时间
- 内存使用情况
- 数据库查询时间
- API响应时间

#### 7.1.2 优化策略
**常用优化方法**:
- 缓存机制
- 懒加载
- 批处理
- 异步处理

### 7.2 架构优化

#### 7.2.1 模块化优化
**优化方向**:
- 进一步模块化
- 微服务化
- 插件化架构

#### 7.2.2 扩展性优化
**考虑因素**:
- 水平扩展
- 负载均衡
- 容错处理

---

## 8. 部署和运维

### 8.1 开发环境

#### 8.1.1 环境设置
**步骤**:
1. 克隆项目
2. 创建虚拟环境
3. 安装依赖: `pip install -r requirements.txt`
4. 配置环境变量
5. 运行测试: `python run_tests.py`

#### 8.1.2 开发工具
**推荐工具**:
- IDE: VS Code, PyCharm
- 调试工具: pdb, ipdb
- 测试工具: pytest
- 代码质量: black, flake8

### 8.2 生产环境

#### 8.2.1 部署方式
**支持方式**:
- Docker部署
- 直接部署
- 云服务部署

#### 8.2.2 监控和日志
**监控指标**:
- 系统资源使用
- API响应时间
- 错误率
- 用户活跃度

---

## 9. 故障排除

### 9.1 常见问题

#### 9.1.1 导入错误
**解决方案**:
- 检查Python路径
- 验证模块安装
- 检查循环依赖

#### 9.1.2 配置错误
**解决方案**:
- 验证环境变量
- 检查配置文件
- 查看错误日志

### 9.2 调试技巧

#### 9.2.1 调试工具
**推荐工具**:
- Python debugger
- 日志分析
- 性能分析

#### 9.2.2 调试方法
**调试步骤**:
1. 重现问题
2. 收集信息
3. 分析原因
4. 解决问题
5. 验证修复

---

## 10. 结语

### 10.1 项目总结
RS Agent MCP项目是一个技术先进、功能完善的微波遥感智能分析代理服务。项目通过模块化架构设计、多模式支持和丰富的业务功能，为用户提供了专业的微波遥感领域AI服务。

### 10.2 开发建议
- **保持代码简洁**: 避免不必要的复杂性
- **注重测试质量**: 确保功能稳定性
- **持续学习**: 跟进最新的AI技术发展
- **团队协作**: 保持良好的沟通和协作

### 10.3 未来展望
- **技术升级**: 持续优化架构和性能
- **功能扩展**: 增加更多专业领域功能
- **用户体验**: 改进交互和界面设计
- **生态建设**: 构建完整的开发和应用生态

---

**最后提醒**: 在进行任何开发工作之前，请确保您已经完全理解了项目的架构和运行逻辑。保持代码的简洁性和可维护性是我们共同的责任。

**开发愉快！** 🚀