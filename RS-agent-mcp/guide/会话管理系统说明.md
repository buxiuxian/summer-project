# 会话管理系统说明

## 概述

会话管理系统为RS Agent智能助手添加了完整的对话历史管理功能，用户可以：
- 创建和管理多个会话
- 在不同会话间切换
- 保存和加载对话历史
- 删除不需要的会话
- 享受上下文连贯的对话体验

## 功能特性

### 1. 会话自动管理
- **自动创建**：用户在空对话框中开始新对话时，系统自动创建新会话
- **自动保存**：每次对话都会自动保存到会话文件中
- **自动标题**：使用AI生成简洁的会话标题，方便识别
- **会话ID**：每个会话都有基于时间戳的唯一ID

### 2. 会话列表管理
- **会话列表**：左侧侧边栏显示所有会话
- **会话信息**：显示会话标题、最后更新时间、消息数量
- **会话切换**：点击会话项可快速切换到该会话
- **会话删除**：支持删除不需要的会话

### 3. 对话历史功能
- **历史加载**：切换会话时自动加载历史对话记录
- **上下文连贯**：AI能够基于历史对话提供连贯的回答
- **实时更新**：新的对话会实时添加到会话历史中

### 4. 智能对话增强
- **上下文理解**：AI能够理解之前的对话内容
- **连贯回答**：基于历史对话提供更准确的回答
- **话题延续**：支持在同一会话中深入探讨话题

## 技术实现

### 后端架构

#### 1. 会话服务 (`chat_session_service.py`)
- 会话创建、更新、删除
- 会话列表管理
- 与RSHub API交互
- 会话标题生成

#### 2. 增强的Agent逻辑
- 支持会话历史的prompt模板
- 修改所有LLM调用以包含历史上下文
- 会话状态管理

#### 3. API端点扩展
- `POST /api/agent/chat/sessions` - 获取会话列表
- `POST /api/agent/chat/sessions/{chat_id}` - 获取会话详情
- `DELETE /api/agent/chat/sessions/{chat_id}` - 删除会话
- `POST /api/agent/chat/sessions/{chat_id}/history` - 获取会话历史

### 前端架构

#### 1. 会话管理组件
- 会话列表侧边栏
- 会话切换功能
- 会话删除操作
- 新建会话按钮

#### 2. 界面布局更新
- 左侧会话列表
- 右侧主对话区域
- 响应式设计支持移动设备

#### 3. 状态管理
- 当前会话跟踪
- 会话列表状态
- 加载状态管理

## 使用方法

### 1. 创建新会话
1. 点击"新建会话"按钮
2. 在对话框中输入问题
3. 系统自动创建新会话并生成标题

### 2. 切换会话
1. 在左侧会话列表中点击任意会话
2. 系统自动加载历史对话记录
3. 可以继续该会话的对话

### 3. 删除会话
1. 将鼠标悬停在会话项上
2. 点击右上角的🗑️删除按钮
3. 确认删除操作

### 4. 隐藏/显示会话列表
1. 点击◀/▶按钮可以隐藏或显示会话列表
2. 在移动设备上，会话列表会以覆盖层形式显示

## 数据结构

### 会话文件格式
```json
{
  "session_id": "1703234567890",
  "title": "微波遥感基础",
  "created_at": "2024-01-01T12:00:00Z",
  "updated_at": "2024-01-01T12:30:00Z",
  "messages": [
    {
      "role": "user",
      "content": "什么是微波遥感？",
      "timestamp": "2024-01-01T12:00:00Z"
    },
    {
      "role": "assistant",
      "content": "微波遥感是...",
      "timestamp": "2024-01-01T12:01:00Z"
    }
  ]
}
```

### API响应格式
```json
{
  "success": true,
  "sessions": [
    {
      "session_id": "1703234567890",
      "title": "微波遥感基础",
      "created_at": "2024-01-01T12:00:00Z",
      "updated_at": "2024-01-01T12:30:00Z",
      "message_count": 6
    }
  ]
}
```

## 配置说明

### 环境变量
- `DEPLOYMENT_MODE`: 部署模式 (local/production)
- `RSHUB_TOKEN`: RSHub API令牌 (本地开发用)

### RSHub API配置
- 基础URL: `https://rshub.zju.edu.cn/api`
- 认证方式: Bearer Token
- 文件格式: JSON

## 测试方法

### 1. 功能测试
1. 登录系统
2. 创建新会话并发送消息
3. 切换到另一个会话
4. 返回第一个会话，确认历史记录正确加载
5. 测试删除会话功能

### 2. 上下文测试
1. 在新会话中问："什么是微波遥感？"
2. 继续问："它有什么应用？"
3. 再问："刚才提到的应用中哪个最重要？"
4. 验证AI是否能理解上下文

### 3. 界面测试
1. 测试会话列表的显示和隐藏
2. 测试响应式布局
3. 测试移动设备上的表现

## 注意事项

### 1. 性能考虑
- 会话历史会影响LLM响应时间
- 建议定期清理不需要的会话
- 长会话可能需要更多token

### 2. 存储限制
- 会话文件存储在RSHub服务器
- 建议监控存储使用情况
- 可考虑实现会话归档功能

### 3. 隐私安全
- 会话内容与用户token绑定
- 删除会话会永久删除数据
- 建议用户定期备份重要会话

## 故障排除

### 1. 会话加载失败
- 检查网络连接
- 验证用户token有效性
- 查看浏览器控制台错误信息

### 2. 历史记录不准确
- 确认会话ID正确
- 检查服务器日志
- 重新加载会话

### 3. 界面显示异常
- 清除浏览器缓存
- 检查CSS样式加载
- 确认JavaScript没有错误

## 未来改进

### 1. 功能增强
- 会话搜索功能
- 会话分类标签
- 会话导出功能
- 会话分享功能

### 2. 性能优化
- 会话内容压缩
- 历史记录分页加载
- 缓存机制改进

### 3. 用户体验
- 会话重命名功能
- 拖拽排序
- 快捷键支持
- 主题定制

## 版本历史

- **v1.4.0** (2024-01-01)
  - 初始版本发布
  - 基础会话管理功能
  - 前后端完整实现
  - 响应式界面设计 