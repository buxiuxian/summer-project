# 文件源信息显示功能说明

## 功能概述

本系统新增了文件源信息显示功能，当AI在回答问题时引用了知识库中的文档内容，系统会在回答下方显示相关的源文件信息，用户可以方便地查看或下载这些文件。

## 最新更新 (2024-12)

### ✅ 已修复的问题

1. **智能进度提示功能恢复**
   - 修复了进度监听功能消失的问题
   - 现在在处理请求时会显示详细的进度信息
   - 支持不同阶段的智能提示（初始化、分析、处理、AI思考、完成等）

2. **文件名长度优化**
   - 实现了智能文件名截断规则
   - 如果文件扩展名前超过40个字符，只保留前40个字符 + "..." + 扩展名
   - 鼠标悬停时显示完整文件名
   - 确保下载/预览时使用原始文件名

3. **界面状态管理**
   - 修复了新请求时上一次参考文件不消失的问题
   - 每次发送新请求时会自动隐藏之前的源文件信息
   - 提供更好的用户体验

4. **JavaScript错误修复**
   - 修复了DOM元素加载顺序导致的TypeError
   - 将事件监听器初始化移到DOMContentLoaded事件中
   - 提高了前端稳定性

## 功能特点

### 智能源文件识别
- 系统会自动分析AI回答中引用的知识来源
- 显示参与生成回答的文档文件信息
- 按相似度排序，最相关的文件排在前面

### 文件信息展示
每个源文件会显示以下信息：
- **文件名**: 智能截断显示，鼠标悬停显示完整名称
- **文件类型**: 自动识别文件扩展名（PDF、TXT、MD等）
- **相似度**: 显示该文件与问题的匹配程度（百分比）

### 智能操作按钮
- **PDF文件**: 显示"浏览"按钮，点击在新窗口中预览PDF内容
- **其他文件**: 显示"下载"按钮，点击下载文件到本地
- **内置知识**: 对于系统内置知识，按钮会被禁用并提示

### 进度提示集成
- **实时进度**: 显示AI处理的详细阶段
- **智能提示**: 根据不同任务类型显示相应提示
- **用户友好**: 使用易懂的语言描述处理过程

## 使用场景

### 1. 知识问答场景
当您询问微波遥感相关问题时：
```
用户：什么是后向散射系数？

[进度提示]
初始化: 正在初始化AI分析任务...
分析中: 正在分析您的问题类型...
处理中: 开始知识问答分析...
AI思考: 正在提取问题关键词...
处理中: 正在从知识库检索相关信息...
AI思考: 正在调用AI模型验证知识相关性...
AI思考: 正在生成专业回答...
完成: AI回答生成完成

AI：后向散射系数是微波遥感中的重要参数...

[文件源信息框]
📄 Microwave_Remote_Sensing_Fund... (相似度: 85.2%)
   PDF 文件                                    [浏览]

📄 radar_theory_basics.txt (相似度: 72.1%)
   TXT 文件                                    [下载]
```

### 2. 文档上传后的问答
当您上传文档并提问时，系统会优先引用您上传的文档，并在源信息中显示。

## 技术实现

### 后端实现
- **知识库查询**: 使用增强的结构化查询获取文档片段和元数据
- **文件映射**: 通过file_mapping_id关联源文件和存储文件
- **相似度计算**: 使用语义相似度算法排序源文件
- **进度报告**: 集成智能进度提示系统

### 前端实现
- **动态渲染**: JavaScript动态生成源文件信息UI
- **智能截断**: 客户端文件名长度优化
- **状态管理**: 自动清理上一次的显示状态
- **错误处理**: 完善的异常处理和用户提示
- **进度监听**: 实时接收服务器端进度更新

### 文件映射系统
- **存储管理**: 原始文件和转换文件的统一管理
- **ID映射**: 通过唯一ID关联文件存储位置
- **预览支持**: PDF文件在线预览功能
- **下载支持**: 其他格式文件直接下载

## API接口

### 聊天API (支持源文件信息)
```
POST /api/v1/agent/chat
```
**请求**:
```json
{
  "message": "用户问题",
  "session_id": "会话ID（可选）",
  "stream": false
}
```

**响应**:
```json
{
  "response": "AI回答",
  "status": "success",
  "task_type": 1,
  "session_id": "session_123",
  "source_files": [
    {
      "file_mapping_id": "abc123",
      "original_filename": "document.pdf",
      "display_name": "document.pdf",
      "file_extension": ".pdf",
      "can_preview": true,
      "similarity": 0.85
    }
  ]
}
```

### 文件预览API
```
GET /api/v1/files/preview/{file_mapping_id}
```

### 文件下载API
```
GET /api/v1/files/download/{file_mapping_id}
```

## 配置说明

### 文件大小限制
- **最大文件大小**: 20MB（已从10MB提升）
- **支持格式**: PDF、DOC、DOCX、TXT、MD
- **批量上传**: 支持多文件同时上传

### 显示配置
- **文件名截断**: 40字符 + "..." + 扩展名
- **最大显示数量**: 通常显示前5个最相关的文件
- **相似度阈值**: 自动过滤低相关性文件

## 故障排除

### 常见问题

**Q: 看不到源文件信息框？**
A: 检查：
1. 确保问题与知识库内容相关
2. 浏览器控制台是否有JavaScript错误
3. 刷新页面重试

**Q: 进度提示不显示？**
A: 检查：
1. 服务器是否正常运行
2. 浏览器是否支持Server-Sent Events
3. 网络连接是否稳定

**Q: 文件下载/预览失败？**
A: 检查：
1. 文件是否仍存在于服务器
2. 文件权限是否正确
3. 网络连接是否正常

### 调试方法
1. 打开浏览器开发者工具（F12）
2. 查看Console标签页的错误信息
3. 查看Network标签页的API请求状态
4. 检查服务器日志

## 未来计划

### 功能增强
- [ ] 支持更多文件格式预览
- [ ] 添加文件内容搜索高亮
- [ ] 实现文件版本管理
- [ ] 增加文件标签和分类

### 性能优化
- [ ] 文件缓存机制
- [ ] 预览内容压缩
- [ ] 异步加载优化

### 用户体验
- [ ] 拖拽上传支持
- [ ] 文件预览模态框
- [ ] 键盘快捷键支持

---

*该功能由RS Agent团队开发维护，旨在提升知识问答的透明度和可信度。* 