# 知识库架构统一说明

## 修改概述

为了解决项目中存在的双知识库不同步问题，我们对知识库架构进行了重大统一修改。

## 问题背景

之前项目中存在两个知识库存储位置：
1. `knowledge_sources/` - 旧的知识库目录
2. `file_storage/` - 新的文件存储系统

这导致了以下问题：
- 两个知识库内容不同步
- 前端显示的文件状态与实际存储不符
- 文件管理混乱，重复存储

## 修改方案

### 统一存储架构

现在项目统一使用 `file_storage/` 作为唯一的知识库存储位置：

```
file_storage/
├── originals/           # 原始文件存储（PDF、DOC、TXT等）
├── converted/           # 转换后的文本文件（用于RAG检索）
└── file_mapping.json   # 文件映射关系
```

### 核心修改

#### 1. 知识库路径配置
- `app/core/config.py`: `KNOWLEDGE_BASE_PATH` 改为 `file_storage`
- `app/rag/knowledge_base.py`: `SOURCE_DOCS_PATH` 改为 `file_storage/converted`

#### 2. API接口修改
- `app/api/knowledge.py`: 所有接口改为使用 `file_storage_manager`
- 前端状态报告现在直接从 `file_storage/originals` 读取
- 文件删除、预览、下载都统一使用文件映射ID

#### 3. 文档加载逻辑
- 知识库现在从 `file_storage/converted` 加载转换后的文档
- 通过 `file_mapping.json` 获取正确的原始文件名
- 确保显示的文件名是原始文件名而非哈希值

#### 4. 脚本更新
- `start.py`: 初始化目录改为 `file_storage`
- `cleanup_knowledge_base.py`: 清理路径统一
- `reset_knowledge_base.py`: 重置路径统一

## 文件映射机制

### file_mapping.json 结构
```json
{
  "mapping_id": {
    "original_filename": "实际文件名.pdf",
    "original_file_id": "哈希ID", 
    "original_path": "file_storage/originals/哈希ID.pdf",
    "file_extension": ".pdf",
    "display_name": "显示文件名.pdf",
    "created_time": "创建时间",
    "converted_file_id": "转换文件哈希ID",
    "converted_path": "file_storage/converted/哈希ID.txt",
    "converted_filename": "转换文件名.txt"
  }
}
```

### 工作流程
1. **文件上传**: 原始文件存储到 `originals/`，转换后存储到 `converted/`
2. **文件映射**: 在 `file_mapping.json` 中记录关系
3. **知识库加载**: 从 `converted/` 读取文本，从映射获取原始文件名
4. **前端显示**: 显示原始文件名和信息，提供预览/下载链接

## 迁移说明

### 自动处理
- 现有的 `file_storage/` 中的文件无需迁移
- 系统会自动忽略旧的 `knowledge_sources/` 目录

### 手动清理（可选）
如果希望完全移除旧目录：
```bash
rm -rf knowledge_sources/
```

## 优势

1. **统一管理**: 只有一个知识库存储位置
2. **文件完整性**: 原始文件和转换文件都妥善保存
3. **正确显示**: 前端显示真实文件名而非哈希值
4. **高效检索**: 使用转换后的文本进行RAG检索
5. **数据一致性**: 前端状态与实际存储完全同步

## 注意事项

1. **向后兼容**: 现有的文件映射关系完全保留
2. **无数据丢失**: 所有现有文件都继续可用
3. **配置更新**: 某些环境变量路径已更新
4. **文档同步**: 相关文档已同步更新

## 测试验证

修改完成后，可以通过以下方式验证：

1. **API测试**: 访问 `/api/v1/knowledge/status` 查看文件状态
2. **功能测试**: 上传、删除、预览文件功能
3. **知识问答**: 确保RAG检索功能正常
4. **前端显示**: 确保文件名正确显示

---

*此文档记录了2024年12月的重大架构调整，确保知识库管理的统一性和一致性。* 