# RSHub数据建模功能说明（instruction=2）

## 功能概述

RSHub数据建模功能是RSagent项目第二阶段的核心功能，它使AI agent能够根据用户的自然语言输入，自动生成参数代码并调用RSHub平台进行微波遥感数据建模。

## 支持的场景和模型

### 1. 雪地场景（Snow）
- **DMRT-QMS模型**（默认）
  - 支持主动模式（后向散射）
  - 支持被动模式（亮温）
- **DMRT-BIC模型**
  - 支持主动模式（后向散射）
  - 支持被动模式（亮温）

### 2. 土壤场景（Soil）
- **AIEM模型**
  - 同时计算主动和被动结果

### 3. 植被场景（Vegetation）
- **VPRT (RT)模型**
  - 目前只支持被动模式（亮温）

## 工作流程

### 环节1：环境检查
- 自动检查并安装RSHub包
- 验证RSHUB_TOKEN配置

### 环节2：任务分析
- 判断场景类型（雪地/土壤/植被）
- 生成唯一的项目名称（包含时间戳）

### 环节3：模型和观测模式选择
- 根据用户需求选择模型
- 确定观测模式（主动/被动/双模式）

### 环节4：参数解析和代码生成
- 读取用户上传的文件
- 解析用户指定的参数
- 生成Python参数代码

### 环节5：任务提交
- 执行参数代码
- 提交任务到RSHub
- 支持错误重试（最多2次）

### 环节6：日志记录（可选）
- 如果用户要求，生成任务日志

### 环节7：任务状态监控
- 前2分钟每10秒检查一次
- 之后每分钟检查一次
- 最长等待30分钟

### 环节8：错误检查
- 验证任务是否成功完成

### 环节9：结果可视化
- 生成结果图表
- 提供任务总结

## 使用示例

### 基本使用
```python
from app.agent.agent import run_analysis_agent

# 雪地建模示例
result = await run_analysis_agent(
    instruction_mode=2,
    user_prompt="请使用DMRT-QMS模型对雪地进行建模，频率设为17.2 GHz",
    output_path="output/"
)
```

### 用户输入示例

1. **雪地场景**
   - "请对雪地进行建模，使用默认参数"
   - "使用DMRT-BIC模型对雪地建模，设置3层雪，厚度分别为10、15、20cm"
   - "雪地建模，我需要同时获得主动和被动模式的结果"

2. **土壤场景**
   - "对土壤表面进行微波散射建模，土壤湿度设为0.25"
   - "土壤建模，观测角度设置为15、30、45、60度"
   - "AIEM模型分析土壤，粗糙度rms高度0.5cm"

3. **植被场景**
   - "对植被覆盖的土壤进行建模"
   - "植被建模，只包含叶片散射体，叶片密度5000/m²"
   - "分析植被亮温，频率1.41 GHz"

### 文件上传支持

支持上传包含参数的文本文件：
- TXT格式
- CSV格式
- MD格式

文件内容示例：
```
频率: 10.2, 17.2 GHz
雪层厚度: 5cm, 10cm, 15cm
雪层密度: 0.15, 0.20, 0.25 g/cm³
土壤湿度: 0.18
```

## 配置要求

### 环境变量
在`.env`文件中添加：
```
RSHUB_TOKEN=your-rshub-token  # 从 https://rshub.zju.edu.cn/Registration 获取
```

### Python依赖
- rshub（自动安装）
- numpy
- matplotlib

## 输出结果

### 1. 文本总结
包含：
- 模拟的场景类型
- 使用的模型
- 观测模式
- 修改的参数
- 任务执行状态

### 2. 图表文件
- 雪地场景：亮温图和/或后向散射图
- 土壤场景：多极化后向散射图
- 植被场景：亮温随角度变化图

### 3. 日志文件（可选）
如果用户要求，生成`rshub_task_log.txt`

## 测试功能

### 简化测试（无需RSHUB_TOKEN）
```bash
python test/test_rshub_simple.py
```
测试内容：
- 场景分类
- 模型选择
- 观测模式判断
- 参数代码生成
- 文档加载

### 完整测试（需要RSHUB_TOKEN）
```bash
python test/test_rshub_workflow.py
```
测试内容：
- 完整的RSHub工作流
- 实际任务提交和执行
- 结果获取和可视化

## 错误处理

### 自动重试机制
- 任务提交失败时自动重试（最多2次）
- 使用AI分析错误原因并修正参数

### 常见错误
1. **未设置RSHUB_TOKEN**
   - 错误信息："未配置RSHUB_TOKEN"
   - 解决：在.env文件中设置token

2. **场景类型不明确**
   - 错误信息："无法确定建模场景类型"
   - 解决：明确指定雪地、土壤或植被之一

3. **参数超出范围**
   - 自动通过AI修正并重试

## 技术实现细节

### 文件结构
```
app/agent/
├── langchain_agent.py      # 主入口，调用RSHub工作流
├── rshub_workflow.py       # RSHub工作流核心实现
└── langchain_prompts.py    # AI提示词模板

workflow_knowledge/
├── snow_parameters.md      # 雪地场景参数文档
├── soil_parameters.md      # 土壤场景参数文档
└── veg_parameters.md       # 植被场景参数文档
```

### 关键函数
- `run_rshub_workflow()`: 主工作流函数
- `_classify_scenario()`: 场景分类
- `_generate_parameter_code()`: 参数代码生成
- `_wait_for_tasks()`: 任务状态监控
- `_generate_plots()`: 结果可视化

## 未来扩展

1. 支持更多模型和参数
2. 增强的错误恢复机制
3. 批量任务处理
4. 结果对比分析
5. 参数优化建议 